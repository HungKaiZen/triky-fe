<!DOCTYPE html>
<html>
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Verify and Set password | Circuit</title>

        <!-- Favicon -->
        <link
            rel="apple-touch-icon"
            sizes="76x76"
            href="./assets/favicon/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="./assets/favicon/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="./assets/favicon/favicon-16x16.png"
        />
        <link rel="manifest" href="./assets/favicon/site.webmanifest" />
        <link
            rel="mask-icon"
            href="./assets/favicon/safari-pinned-tab.svg"
            color="#5bbad5"
        />
        <meta name="msapplication-TileColor" content="#da532c" />
        <meta name="theme-color" content="#ffffff" />

        <!-- Google fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <!-- Styles -->
        <link rel="stylesheet" href="./assets/css/main.css" />

        <!-- Animation -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        />

        <!-- Script -->
        <script src="./assets/js/script.js"></script>
    </head>
<body>
    <header id="header" class="header"></header>
    <script>
        load("#header", "./templates/header.html");
    </script>

    <div class="verify_main" style="height: 62.5vh; background-color: #032e32;">
        <div class="container" style="display: flex; justify-content: center; align-items: center; height: 100%;">
            <div class="verify__content" style="padding: 60px; display: flex; justify-content: center; align-items: center; flex-direction: column; border-radius: 12px; background-color: #e0eae5;">
                <h1 style="text-align: center; font-size: 32px;margin-bottom: 60px;">Cài đặt mật khẩu</h1>

                <form action="" id="setPassword" class="form">
                    <div class="form__group">
                        <label for="verify-token" class="form__label">Mã Xác Thực</label>
                        <div class="form__group-horizontal form__group-horizontal-border" style="width: 500px;">
                        <input type="text" id="verify-token" size="6" placeholder="Nhập mã xác thực" class="form__group-input" style="width: 500px;">
                        </div>
                        <p class="form__error-verify"></p>
                  </div>
                    <div class="form__group" style="margin-top: 16px;">
                        <label for="password" class="form__label">Mật khẩu</label>
                        <div class="form__group-horizontal form__group-horizontal-border" style="width: 500px;">
                        <input type="password" id="password" size="6" placeholder="Nhập mật khẩu" class="form__group-input" style="width: 500px;">
                        </div>
                  </div>

                  <div class="form__group" style="margin-top: 16px;">
                        <label for="rePassword" class="form__label">Nhập mật khẩu</label>
                        <div class="form__group-horizontal form__group-horizontal-border" style="width: 500px;">
                            <input type="password" id="rePassword" placeholder="Nhập lại mật khẩu" class="form__group-input">
                        </div>
                        <p class="form__error" id="form__error"></p>
                  </div>
                  <p id="msg" style="color: red; font-size: 14px;"></p>
                  <button type="submit" class="btn auth__submit-btn" style="width: 140px; height: 52px; margin: 50px auto 0 auto;">Cài đặt</button>
                </form>
            </div>
        </div>
    </div>


    <footer id="footer" class="footer"></footer>
    <script>
        load("#footer", "./templates/footer.html");
    </script>

    <script>
        const baseURL = "http://localhost:8080";
        document.getElementById("setPassword").addEventListener("submit", function(event) {
        event.preventDefault()
        let password = document.getElementById("password").value
        let confirmPassword = document.getElementById("rePassword").value
        let token =document.getElementById("verify-token").value;

        if(password === confirmPassword) {
            const userData = {
            token: token,
            password: password,
            confirmPassword: confirmPassword
            };


            fetch(`${baseURL}/auth/verify-and-set-password`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(userData)
            })
            .then(res => res.json())
            .then(data => {
                console.log("Raw API response:", data);
                if(data.data && data.data.toLowerCase() === "password saved") {
                    document.getElementById("msg").innerText = "Xác thực và cài đặt mật nhẩu thành công";
                    setTimeout(() => {
                       window.location.href = "login.html";
                    }, 3000);
                }else if (data.data && data.data.toLowerCase() === "user already enabled"){
                    document.getElementById("msg").innerText = "Tài khoản đã được xác thực thành công, Mời bạn đăng nhập";
                    setTimeout(() => {
                       window.location.href = "login.html";
                    }, 3000);
                }else if (data.data && data.data.toLowerCase() === "invalid token"){
                    document.getElementById("form__error-verify").innerText = "Mã xác thực không hợp lệ";
                }else if (data.data && data.data.toLowerCase() === "token expired"){
                    document.getElementById("form__error-verify").innerText = "Mã xác thực đã hết hạn";
                }else if (data.data) { // Nếu API trả lỗi
                    let errorMsg = document.getElementById("form__error");
                    errorMsg.style.display = "block";
                    errorMsg.innerText = data.data;
                }
            })
            .catch(error => {
                let errorMsg = document.getElementById("form__error");
                errorMsg.style.display = "block";
                errorMsg.innerText = "Có lỗi xảy ra khi kết nối server!";
                if(error) {

                    console.error(error);
                }
            })

        }else {
            let errorMsg = document.getElementById("form__error");
            errorMsg.style.display = "block";
            errorMsg.innerText = "Mật khẩu không khớp."
        }

       })
    </script>


    </script>
</body>
</html>
